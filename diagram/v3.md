# V3 - OpenSpec Verification Integration

```mermaid
flowchart TD
    A["开始：收到需求/想法"] --> A_Check{"有明确需求描述?"}

    %% Source Collection Phase (V2)
    A_Check -- "否 (无参数调用)" --> SC["Source Collection Phase<br/>收集信息来源"]
    A_Check -- "是" --> B

    SC --> SC1["AskUserQuestion<br/>Jira URL (选填)<br/>API URL (可跳过)<br/>Figma URL (可跳过)"]

    SC1 --> SC_Jira{Jira 已提供?}
    SC_Jira -- "否" --> SC2["补充需求描述<br/>要解决什么问题?<br/>期望什么功能?"]
    SC_Jira -- "是" --> SC3
    SC2 --> SC3["Fetch MCP Information<br/>apifox-mcp → API 摘要<br/>figmap-mcp → 设计摘要"]

    SC3 --> SC4["确定 feature-name<br/>创建 sources.md"]
    SC4 --> B

    %% Original brainstorming flow
    B["brainstorming<br/>澄清需求 & 产出设计<br/>分段展示后确认"]

    %% 设计确认逻辑
    B --> B_Check{"设计是否确认?"}
    B_Check -- "未确认" --> B
    B_Check -- "确认" --> OS_Ask{"创建 OpenSpec<br/>change 文档?"}

    %% OpenSpec 分支
    OS_Ask -- "是" --> OS_Create["创建 OpenSpec change 结构<br/>sources.md (已存在则保留)<br/>proposal.md / design.md<br/>tasks.md / plan/"]
    OS_Ask -- "否" --> C
    OS_Create --> C

    C["using-git-worktrees<br/>创建隔离 worktree/分支<br/>验证干净基线"]

    C --> D["writing-plans<br/>读取 OpenSpec 上下文<br/>拆成 2-5 分钟任务<br/>输出到 plan/"]

    D --> E["subagent-driven-development<br/>或 executing-plans<br/>读取 OpenSpec 上下文"]
    E --> F["逐任务实现"]

    %% TDD loop
    F --> G["TDD 循环<br/>RED - GREEN - REFACTOR"]
    G --> H["requesting-code-review<br/>两阶段审查<br/>1.规格符合 2.代码质量"]

    H -- "发现问题" --> F
    H -- "通过" --> I{"任务都完成了吗?"}

    I -- "否" --> F
    I -- "是" --> OS_Sync["同步 OpenSpec tasks.md<br/>标记所有任务完成"]

    OS_Sync --> J["verification-before-completion<br/>运行验证命令并拿到证据"]

    %% Completion gate
    J --> J_Check{"验证是否通过?"}
    J_Check -- "失败" --> F

    %% NEW in V3: OpenSpec Verification
    J_Check -- "通过" --> OV["openspec-verification<br/>PRD 一致性校验"]
    OV --> OV_Check{"校验是否通过?"}
    OV_Check -- "失败" --> F
    OV_Check -- "通过" --> K["finishing-a-development-branch<br/>测试全绿后给 4 个收尾选项"]

    K --> L1["选项1: 本地合并到主分支"]
    K --> L2["选项2: 推送并创建 PR"]
    K --> L3["选项3: 保留分支稍后处理"]
    K --> L4["选项4: 丢弃这次工作"]

    %% PR feedback loop
    L2 --> M["receiving-code-review<br/>读取反馈后逐条实现"]
    M --> F

    L1 --> OS_Archive["openspec archive<br/>归档 OpenSpec change"]
    L3 --> Z["结束"]
    L4 --> Z
    OS_Archive --> Z["结束"]

    %% Styling for source collection (V2)
    style SC fill:#e1f5fe
    style SC1 fill:#e1f5fe
    style SC2 fill:#e1f5fe
    style SC3 fill:#e1f5fe
    style SC4 fill:#e1f5fe
    style SC_Jira fill:#e1f5fe
    style A_Check fill:#e1f5fe

    %% Styling for openspec-verification (V3 NEW)
    style OV fill:#fff3e0
    style OV_Check fill:#fff3e0
```

## V3 Changes (OpenSpec Verification Integration)

| Step | Change |
|------|--------|
| openspec-verification | NEW: PRD consistency verification step after verification-before-completion |
| Check Content | Document consistency, PRD completeness, implementation consistency |
| Trigger | Auto in workflow OR `/verify-openspec` manual command |
| Fail Action | Return to implementation phase to fix issues |

## OpenSpec Verification Flow Detail

```mermaid
flowchart LR
    subgraph "OpenSpec Verification Phase"
        V1["Locate OpenSpec<br/>change directory"] --> V2["Collect documents<br/>sources/proposal/tasks/design"]
        V2 --> V3["Get git diff<br/>BASE..HEAD"]
        V3 --> V4["Dispatch verifier<br/>subagent"]
        V4 --> V5{"Verdict?"}
        V5 -- "PASS" --> V6["Proceed to<br/>finishing-branch"]
        V5 -- "FAIL" --> V7["List blocking issues<br/>Return to implementation"]
    end
```

## Verification Checks

| Check | Description | Pass Criteria |
|-------|-------------|---------------|
| Document Consistency | Compare OpenSpec docs for conflicts | No contradictions between sources/proposal/tasks/design |
| PRD Completeness | Verify all requirements implemented | 100% requirements have code |
| PRD Consistency | Verify implementation matches description | Behavior aligns with PRD |

## OpenSpec Directory Structure (V3)

```
openspec/changes/<feature-name>/
├── sources.md       # Information sources and PRD (from source collection)
├── proposal.md      # Why we're doing this (OpenSpec standard)
├── design.md        # Technical decisions (optional)
├── tasks.md         # High-level task overview
├── plan/
│   └── YYYY-MM-DD-v<N>.md
└── specs/
    └── <spec-name>/
        └── spec.md
```

## Comparison: V2 vs V3

| Aspect | V2 | V3 |
|--------|----|----|
| Pre-completion check | verification-before-completion only | verification-before-completion + openspec-verification |
| PRD alignment | Not verified | Verified by subagent |
| Document consistency | Not checked | Checked across all OpenSpec docs |
| Manual trigger | N/A | `/verify-openspec` command |

## Version History

| Version | Key Changes |
|---------|-------------|
| V1 | Original workflow |
| V2 | Added Source Collection Phase |
| V3 | Added OpenSpec Verification step |
